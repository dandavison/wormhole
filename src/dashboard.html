<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <title>Wormhole</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: 'SF Mono', 'Menlo', 'Monaco', monospace;
        background-color: #fdfeff;
        background-image:
          linear-gradient(#eef1f4 1px, transparent 1px),
          linear-gradient(90deg, #eef1f4 1px, transparent 1px);
        background-size: 20px 20px;
        min-height: 100vh;
        padding: 3rem 2rem 2rem 3rem;
      }
      header {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #333;
      }
      h1 {
        font-size: 1.25rem;
        font-weight: 600;
        letter-spacing: 0.1em;
        color: #333;
      }
      .grid {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .card {
        background: #fff;
        border: 1px solid #ccc;
        padding: 1rem;
        box-shadow: 2px 2px 0 #ddd;
      }
      .card.current {
        border-color: #0066cc;
        box-shadow: 2px 2px 0 #0066cc;
      }
      .card[data-task].switching {
        opacity: 0.6;
      }
      .card.folded .card-meta,
      .card.folded .card-content,
      .card.folded .card-actions,
      .card.folded .iframe-container,
      .card.folded .no-task {
        display: none;
      }
      .card.folded .card-header {
        margin-bottom: 0;
      }
      .card-header {
        display: flex;
        align-items: baseline;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
      }
      .card-header .card-summary {
        flex: 1;
        margin-bottom: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .card-header .card-status {
        margin-left: auto;
        flex-shrink: 0;
      }
      .card-repo {
        font-weight: normal;
        font-size: 0.9rem;
        color: #1a1a1a;
      }
      .card-branch {
        font-weight: 600;
        font-size: 0.9rem;
        color: #1a1a1a;
        cursor: pointer;
      }
      .card-branch:hover {
        text-decoration: underline;
      }
      .card-status {
        font-size: 0.75rem;
        padding: 0.125rem 0.5rem;
        border-radius: 2px;
        background: #eee;
        color: #555;
      }
      .card-summary {
        font-weight: normal;
        font-size: 0.85rem;
        color: #444;
        line-height: 1.4;
      }
      .card-meta {
        font-size: 0.75rem;
        color: #666;
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }
      .card-content {
        margin-top: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: #f8f9fa;
        border-left: 3px solid #ccc;
        font-size: 0.8rem;
        line-height: 1.5;
        color: #333;
      }
      .card-content p {
        margin: 0.25rem 0;
      }
      .card-content a {
        color: #0066cc;
        text-decoration: none;
      }
      .card-content a:hover {
        text-decoration: underline;
      }
      .card-content ul,
      .card-content ol {
        margin: 0.25rem 0 0.25rem 1.25rem;
      }
      .card-content code {
        font-family: inherit;
        background: #e9ecef;
        padding: 0.1rem 0.3rem;
        border-radius: 2px;
      }
      .card-content pre {
        background: #e9ecef;
        padding: 0.5rem;
        overflow-x: auto;
        margin: 0.25rem 0;
      }
      .card-content pre code {
        background: none;
        padding: 0;
      }
      .card-content h1,
      .card-content h2,
      .card-content h3 {
        font-size: 0.85rem;
        margin: 0.5rem 0 0.25rem;
      }
      .card-content table {
        border-collapse: collapse;
        margin: 0.25rem 0;
      }
      .card-content th,
      .card-content td {
        border: 1px solid #ccc;
        padding: 0.2rem 0.5rem;
        font-size: 0.75rem;
      }
      .meta-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
      }
      .meta-item a {
        color: #0066cc;
        text-decoration: none;
      }
      .meta-item a:hover {
        text-decoration: underline;
      }
      .assignee-warning {
        color: #b45309;
        background: #fef3c7;
        padding: 0.125rem 0.375rem;
        border-radius: 2px;
      }
      .card-sprint {
        color: #4338ca;
        background: #e0e7ff;
        padding: 0.125rem 0.375rem;
        border-radius: 2px;
      }
      .no-task {
        font-size: 0.7rem;
        color: #888;
        font-style: italic;
        margin-top: 0.5rem;
      }
      .card-actions {
        margin-top: 0.75rem;
        display: flex;
        gap: 0.5rem;
      }
      .btn {
        font-family: inherit;
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border: 1px solid #999;
        background: #fff;
        color: #666;
        cursor: pointer;
        transition:
          background 0.1s,
          color 0.1s,
          opacity 0.1s;
      }
      .btn:hover {
        background: #666;
        color: #fff;
      }
      .btn-icon {
        padding: 0.25rem;
        border: none;
        background: transparent;
        opacity: 0.7;
      }
      .btn-icon:hover {
        background: transparent;
        opacity: 1;
      }
      .btn-icon img {
        width: 24px;
        height: 24px;
        display: block;
      }
      .btn-vscode.active {
        opacity: 1;
        background: rgba(0, 102, 204, 0.1);
        border-radius: 4px;
      }
      .btn-maximize {
        display: none;
      }
      .iframe-container.expanded ~ .card-actions .btn-maximize,
      .card.expanded .btn-maximize {
        display: inline-block;
      }
      .iframe-container {
        display: none;
        margin-top: 0.75rem;
        border: 1px solid #ccc;
      }
      .iframe-container.expanded {
        display: block;
      }
      .iframe-container iframe {
        width: 100%;
        height: 600px;
        border: none;
      }
      .card.expanded {
        max-width: none;
      }
      .card.maximized {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        max-width: none;
        margin: 0;
        border-radius: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .card.maximized .iframe-container {
        flex: 1;
        margin-top: 0;
        border: none;
      }
      .card.maximized .iframe-container iframe {
        height: 100%;
      }
      .card.maximized .card-actions {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        margin: 0;
        z-index: 1001;
      }
      .card.maximized > *:not(.card-actions):not(.iframe-container) {
        display: none;
      }
      .card.maximized .btn-terminal,
      .card.maximized .btn-cursor,
      .card.maximized .btn-vscode {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="grid">{{CARDS}}</div>
    <script>
      document.querySelectorAll('.card:not(.current)').forEach((card) => {
        card.classList.add('folded');
      });

      document.querySelectorAll('.card-header').forEach((header) => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', (e) => {
          if (e.target.tagName === 'A') return;
          e.stopPropagation();
          header.closest('.card').classList.toggle('folded');
        });
      });

      document.querySelectorAll('.btn-vscode').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const card = btn.closest('.card');
          const container = card.querySelector('.iframe-container');
          const iframe = container.querySelector('iframe');
          const isExpanding = !container.classList.contains('expanded');

          container.classList.toggle('expanded');
          card.classList.toggle('expanded');
          btn.classList.toggle('active');

          if (isExpanding) {
            if (!iframe.src) {
              iframe.src = iframe.dataset.src;
            }
            fetch('/project/switch/' + card.dataset.task + '?skip-editor=true');
          }
        });
      });

      document.querySelectorAll('.btn-cursor').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const task = btn.closest('.card').dataset.task;
          fetch('/project/switch/' + task);
        });
      });

      document.querySelectorAll('.btn-terminal').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const task = btn.closest('.card').dataset.task;
          fetch(
            '/project/switch/' + task + '?skip-editor=true&focus-terminal=true',
          );
        });
      });

      document.querySelectorAll('.btn-maximize').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const card = btn.closest('.card');
          const isMaximized = card.classList.toggle('maximized');
          btn.textContent = isMaximized ? 'Restore' : 'Maximize';
          document.body.style.overflow = isMaximized ? 'hidden' : '';
        });
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const maximized = document.querySelector('.card.maximized');
          if (maximized) {
            maximized.classList.remove('maximized');
            maximized.querySelector('.btn-maximize').textContent = 'Maximize';
            document.body.style.overflow = '';
          }
        }
      });

      document.querySelectorAll('.plan-link').forEach((link) => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          fetch(link.dataset.url);
        });
      });

      document.querySelectorAll('.card-branch').forEach((branch) => {
        branch.addEventListener('click', (e) => {
          e.stopPropagation();
          const key = branch.dataset.key;
          if (!key) return;
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(key).catch(() => copyFallback(key));
          } else {
            copyFallback(key);
          }
        });
      });

      function copyFallback(text) {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
      }

      // Long-poll for current project changes, reload on change
      (async function poll(current, isFirstPoll) {
        try {
          const res = await fetch(
            '/project/current/poll?current=' +
              encodeURIComponent(current || ''),
            { headers: { Prefer: 'wait=30' } },
          );
          const data = await res.json();
          if (data.changed && !isFirstPoll) {
            location.reload();
          } else {
            poll(data.current, false);
          }
        } catch (e) {
          setTimeout(() => poll(current, false), 5000);
        }
      })(null, true);
    </script>
  </body>
</html>
